global
  log 127.0.0.1   local0
  log 127.0.0.1   local1 notice
  #log loghost    local0 info
  maxconn <%= node['haproxy']['global_max_connections'] %>
  #debug
  #quiet
  user <%= node['haproxy']['user'] %>
  group <%= node['haproxy']['group'] %>
<% if node['haproxy']['enable_stats_socket'] -%>
  stats socket <%= node['haproxy']['stats_socket_path'] %> user <%= node['haproxy']['stats_socket_user'] %> group <%= node['haproxy']['stats_socket_group'] %>
<% end -%>

defaults
  log     global
  mode    http
  retries 3
<% @defaults_timeouts.sort.map do | value, time | -%>
  timeout <%= value %> <%= time %>
<% end -%>
<% @defaults_options.sort.each do | option | -%>
  option <%= option %>
<% end -%>
  balance  <%= node['haproxy']['balance_algorithm'] %>
  stats auth <%= node["haproxy"]["stats_user"] %>:<%= node["haproxy"]["stats_password"] %>
  stats uri <%= node["haproxy"]["stats_url"] %>


# Set up application listeners here.

frontend https-in
    bind :443 ssl crt /etc/ssl/certs/STAR_thefrontlog_com.pem
    timeout client 86400000
    default_backend www_backend
    acl is_websocket hdr(Upgrade) -i WebSocket
    acl is_websocket hdr_beg(Host) -i ws

    use_backend socket_backend if is_websocket

backend www_backend
    balance roundrobin
    option forwardfor # This sets X-Forwarded-For
    timeout server 30000
    timeout connect 4000
    server apiserver 184.72.85.114:4984 weight 1 maxconn 1024 check

backend socket_backend
    balance roundrobin
    option forwardfor # This sets X-Forwarded-For
    timeout queue 5000
    timeout server 86400000
    timeout connect 86400000
    server apiserver 184.72.85.114:4984 weight 1 maxconn 1024 check